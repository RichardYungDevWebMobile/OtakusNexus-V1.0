// lib/ai/ai-manager.js

/**
 *  * Gestionnaire centralis√© des fonctionnalit√©s IA
  * Coordonne les diff√©rents fournisseurs et g√®re la persistance
   */

   import { aiProviders } from './providers';
   import { chatPersistence } from './chat-persistence';
   import { quotaManager } from './quota-manager';
   import { localStore } from '../storage/local-storage';

   class AIManager {
     constructor() {
         this.providers = aiProviders;
             this.activeChats = new Map();
                 this.userPreferences = {};
                   }

                     /**
                        * Initialiser le gestionnaire IA
                           */
                             async initialize(userId) {
                                 try {
                                       // Initialiser la persistance
                                             await chatPersistence.initialize(userId);
                                                   
                                                         // Charger les pr√©f√©rences utilisateur
                                                               this.userPreferences = await localStore.get('ai_preferences') || {};
                                                                     
                                                                           // Initialiser les fournisseurs
                                                                                 for (const [name, provider] of Object.entries(this.providers)) {
                                                                                         await provider.initialize?.();
                                                                                               }
                                                                                                     
                                                                                                           console.log('AI Manager initialized successfully');
                                                                                                                 return true;
                                                                                                                     } catch (error) {
                                                                                                                           console.error('AI Manager initialization failed:', error);
                                                                                                                                 return false;
                                                                                                                                     }
                                                                                                                                       }

                                                                                                                                         /**
                                                                                                                                            * Obtenir la liste des IA disponibles
                                                                                                                                               */
                                                                                                                                                 getAvailableAIs() {
                                                                                                                                                     return [
                                                                                                                                                           {
                                                                                                                                                                   id: 'nexus_chatbot',
                                                                                                                                                                           name: 'Nexus Chatbot',
                                                                                                                                                                                   description: 'Assistant conversationnel sp√©cialis√© en anime et manga',
                                                                                                                                                                                           icon: 'ü§ñ',
                                                                                                                                                                                                   category: 'chat',
                                                                                                                                                                                                           provider: 'openai',
                                                                                                                                                                                                                   features: ['chat', 'recommendations', 'trivia'],
                                                                                                                                                                                                                           isFree: true,
                                                                                                                                                                                                                                   dailyLimit: 20,
                                                                                                                                                                                                                                         },
                                                                                                                                                                                                                                               {
                                                                                                                                                                                                                                                       id: 'nexus_artist',
                                                                                                                                                                                                                                                               name: 'Nexus Artist',
                                                                                                                                                                                                                                                                       description: 'G√©n√©rateur d\'images de style anime',
                                                                                                                                                                                                                                                                               icon: 'üé®',
                                                                                                                                                                                                                                                                                       category: 'image',
                                                                                                                                                                                                                                                                                               provider: 'replicate',
                                                                                                                                                                                                                                                                                                       features: ['image_generation', 'style_transfer'],
                                                                                                                                                                                                                                                                                                               isFree: false,
                                                                                                                                                                                                                                                                                                                       creditsPerUse: 5,
                                                                                                                                                                                                                                                                                                                             },
                                                                                                                                                                                                                                                                                                                                   {
                                                                                                                                                                                                                                                                                                                                           id: 'flash_coder',
                                                                                                                                                                                                                                                                                                                                                   name: 'Flash Coder',
                                                                                                                                                                                                                                                                                                                                                           description: 'Assistant pour le d√©veloppement web et CSS',
                                                                                                                                                                                                                                                                                                                                                                   icon: 'üíª',
                                                                                                                                                                                                                                                                                                                                                                           category: 'code',
                                                                                                                                                                                                                                                                                                                                                                                   provider: 'openai',
                                                                                                                                                                                                                                                                                                                                                                                           features: ['code_generation', 'debugging', 'explanation'],
                                                                                                                                                                                                                                                                                                                                                                                                   isFree: true,
                                                                                                                                                                                                                                                                                                                                                                                                           dailyLimit: 10,
                                                                                                                                                                                                                                                                                                                                                                                                                 },
                                                                                                                                                                                                                                                                                                                                                                                                                     ];
                                                                                                                                                                                                                                                                                                                                                                                                                       }

                                                                                                                                                                                                                                                                                                                                                                                                                         /**
                                                                                                                                                                                                                                                                                                                                                                                                                            * D√©marrer une conversation avec une IA
                                                                                                                                                                                                                                                                                                                                                                                                                               */
                                                                                                                                                                                                                                                                                                                                                                                                                                 async startAIConversation(aiId, initialMessage = null) {
                                                                                                                                                                                                                                                                                                                                                                                                                                     try {
                                                                                                                                                                                                                                                                                                                                                                                                                                           const ai = this.getAvailableAIs().find(a => a.id === aiId);
                                                                                                                                                                                                                                                                                                                                                                                                                                                 if (!ai) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                         throw new Error(`AI not found: ${aiId}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                               }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                     // V√©rifier les quotas
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           if (!await quotaManager.canUseAI(aiId, ai.isFree ? 'free' : 'premium')) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   throw new Error('Quota exceeded or insufficient credits');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               // Cr√©er ou r√©cup√©rer le chat
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     let chat = await chatPersistence.getAIChat(aiId);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 if (!chat) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         chat = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   id: `ai_${aiId}_${Date.now()}`,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             aiId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       title: ai.name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 icon: ai.icon,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           createdAt: Date.now(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     messages: [],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               metadata: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           usageCount: 0,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       lastUsed: Date.now(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         await chatPersistence.saveAIChat(chat);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     // Enregistrer le chat comme actif
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           this.activeChats.set(chat.id, {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ...chat,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ai,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   provider: this.providers[ai.provider],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               // Envoyer un message initial si fourni
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     if (initialMessage) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             const response = await this.sendMessage(chat.id, initialMessage);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               success: true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         chat,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   initialResponse: response,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       return { success: true, chat };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 console.error('Start AI conversation error:', error);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       return { success: false, error: error.message };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              *    * Envoyer un message √† une IA
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   async sendMessage(chatId, content, options = {}) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             const activeChat = this.activeChats.get(chatId);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   if (!activeChat) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           throw new Error('Chat not found or not active');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       const { ai, provider } = activeChat;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   // V√©rifier les quotas
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         if (!await quotaManager.canUseAI(ai.id, ai.isFree ? 'free' : 'premium')) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 throw new Error('Quota exceeded or insufficient credits');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             // Cr√©er le message utilisateur
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   const userMessage = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           id: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   role: 'user',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           content,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   timestamp: Date.now(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           metadata: options.metadata || {},
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       // Sauvegarder le message utilisateur
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             await chatPersistence.addMessage(chatId, userMessage);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   // Notifier les √©couteurs
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         this.notifyMessage(chatId, userMessage);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               // G√©n√©rer la r√©ponse de l'IA
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     const aiResponse = await provider.generateResponse({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             aiId: ai.id,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     messages: [...activeChat.messages, userMessage],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             options: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       temperature: this.userPreferences.temperature || 0.7,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 maxTokens: this.userPreferences.maxTokens || 500,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ...options,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               // Cr√©er le message IA
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     const aiMessage = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             id: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     role: 'assistant',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             content: aiResponse.content,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     timestamp: Date.now(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             metadata: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ...aiResponse.metadata,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 provider: ai.provider,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           model: aiResponse.model,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     usage: aiResponse.usage,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         // Sauvegarder le message IA
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               await chatPersistence.addMessage(chatId, aiMessage);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     // Mettre √† jour le compteur d'utilisation
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           await quotaManager.recordUsage(ai.id, ai.isFree ? 'free' : 'premium');

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 // Mettre √† jour le chat actif
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       activeChat.messages.push(userMessage, aiMessage);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             activeChat.metadata.usageCount += 1;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   activeChat.metadata.lastUsed = Date.now();

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         // Notifier les √©couteurs
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               this.notifyMessage(chatId, aiMessage);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             success: true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     message: aiMessage,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             usage: aiResponse.usage,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             console.error('Send message to AI error:', error);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         // Sauvegarder un message d'erreur
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               const errorMessage = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       id: `error_${Date.now()}`,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               role: 'system',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       content: `D√©sol√©, une erreur est survenue : ${error.message}`,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               timestamp: Date.now(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       metadata: { error: true },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   await chatPersistence.addMessage(chatId, errorMessage);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         this.notifyMessage(chatId, errorMessage);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       success: false,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               error: error.message,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       errorMessage,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * G√©n√©rer une image avec l'IA
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             async generateImage(prompt, options = {}) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       const aiId = 'nexus_artist';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             const ai = this.getAvailableAIs().find(a => a.id === aiId);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         // V√©rifier les cr√©dits pour l'IA premium
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               if (!await quotaManager.canUseAI(aiId, 'premium')) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       throw new Error('Insufficient credits for image generation');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   const provider = this.providers[ai.provider];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               // G√©n√©rer l'image
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     const result = await provider.generateImage({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             prompt,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     options: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               width: options.width || 512,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         height: options.height || 512,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   style: options.style || 'anime',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ...options,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           });

// Enregistrer l'utilisation
      await quotaManager.recordUsage(aiId, 'premium', ai.creditsPerUse || 5);

            // Sauvegarder dans l'historique
                  await chatPersistence.saveGeneratedImage({
                          id: result.id,
                                  prompt,
                                          url: result.url,
                                                  timestamp: Date.now(),
                                                          metadata: result.metadata,
                                                                });

                                                                      return {
                                                                              success: true,
                                                                                      image: result,
                                                                                              remainingCredits: await quotaManager.getRemainingCredits('premium'),
                                                                                                    };
                                                                                                        } catch (error) {
                                                                                                              console.error('Generate image error:', error);
                                                                                                                    return {
                                                                                                                            success: false,
                                                                                                                                    error: error.message,
                                                                                                                                          };
                                                                                                                                              }
                                                                                                                                                }

                                                                                                                                                  /**
                                                                                                                                                     * Obtenir l'historique des conversations IA
                                                                                                                                                        */
                                                                                                                                                          async getAIChats() {
                                                                                                                                                              try {
                                                                                                                                                                    const chats = await chatPersistence.getAllAIChats();
                                                                                                                                                                          
                                                                                                                                                                                // Trier par derni√®re utilisation
                                                                                                                                                                                      chats.sort((a, b) => (b.metadata?.lastUsed || 0) - (a.metadata?.lastUsed || 0));
                                                                                                                                                                                            
                                                                                                                                                                                                  return { success: true, chats };
                                                                                                                                                                                                      } catch (error) {
                                                                                                                                                                                                            console.error('Get AI chats error:', error);
                                                                                                                                                                                                                  return { success: false, error: error.message, chats: [] };
                                                                                                                                                                                                                      }
                                                                                                                                                                                                                        }

                                                                                                                                                                                                                          /**
                                                                                                                                                                                                                             * Supprimer une conversation IA
                                                                                                                                                                                                                                */
                                                                                                                                                                                                                                  async deleteAIChat(chatId) {
                                                                                                                                                                                                                                      try {
                                                                                                                                                                                                                                            await chatPersistence.deleteAIChat(chatId);
                                                                                                                                                                                                                                                  this.activeChats.delete(chatId);
                                                                                                                                                                                                                                                        return { success: true };
                                                                                                                                                                                                                                                            } catch (error) {
                                                                                                                                                                                                                                                                  console.error('Delete AI chat error:', error);
                                                                                                                                                                                                                                                                        return { success: false, error: error.message };
                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                /**
                                                                                                                                                                                                                                                                                   * Mettre √† jour les pr√©f√©rences IA
                                                                                                                                                                                                                                                                                      */
                                                                                                                                                                                                                                                                                        async updatePreferences(preferences) {
                                                                                                                                                                                                                                                                                            try {
                                                                                                                                                                                                                                                                                                  this.userPreferences = { ...this.userPreferences, ...preferences };
                                                                                                                                                                                                                                                                                                        await localStore.set('ai_preferences', this.userPreferences);
                                                                                                                                                                                                                                                                                                              return { success: true, preferences: this.userPreferences };
                                                                                                                                                                                                                                                                                                                  } catch (error) {
                                                                                                                                                                                                                                                                                                                        console.error('Update AI preferences error:', error);
                                                                                                                                                                                                                                                                                                                              return { success: false, error: error.message };
                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                      /**
                                                                                                                                                                                                                                                                                                                                         * Obtenir les statistiques d'utilisation
                                                                                                                                                                                                                                                                                                                                            */
                                                                                                                                                                                                                                                                                                                                              async getUsageStats() {
                                                                                                                                                                                                                                                                                                                                                  try {
                                                                                                                                                                                                                                                                                                                                                        const stats = await quotaManager.getUsageStats();
                                                                                                                                                                                                                                                                                                                                                              const chats = await this.getAIChats();
                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                          return {
                                                                                                                                                                                                                                                                                                                                                                                  success: true,
                                                                                                                                                                                                                                                                                                                                                                                          stats: {
                                                                                                                                                                                                                                                                                                                                                                                                    ...stats,
                                                                                                                                                                                                                                                                                                                                                                                                              totalChats: chats.chats?.length || 0,
                                                                                                                                                                                                                                                                                                                                                                                                                        activeChats: this.activeChats.size,
                                                                                                                                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                                                                                                                                      };
                                                                                                                                                                                                                                                                                                                                                                                                                                          } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                console.error('Get AI usage stats error:', error);
                                                                                                                                                                                                                                                                                                                                                                                                                                                      return { success: false, error: error.message };
                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                              /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * Notifier les √©couteurs de nouveaux messages
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      notifyMessage(chatId, message) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // √âv√©nement global pour les √©couteurs
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const event = new CustomEvent('ai_message', {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    detail: { chatId, message },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            window.dispatchEvent(event);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * Nettoyer les ressources
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        async cleanup() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            this.activeChats.clear();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                await chatPersistence.cleanup();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // Singleton pour le gestionnaire IA
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  export const aiManager = new AIManager();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        