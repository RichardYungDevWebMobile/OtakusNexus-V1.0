// app/_layout.jsx

/**
 * Layout racine de l'application Otakus Nexus
  * Gère l'authentification, le thème et les fournisseurs globaux
   */

   import React from 'react';
   import { Stack } from 'expo-router';
   import { StatusBar } from 'expo-status-bar';
   import { GestureHandlerRootView } from 'react-native-gesture-handler';
   import { SafeAreaProvider } from 'react-native-safe-area-context';
   import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
   import { useFonts } from 'expo-font';

   // Contextes et fournisseurs
   import { AuthProvider } from '../lib/auth/auth-context';
   import { ThemeProvider } from '../lib/theme/theme-context';
   import { ErrorBoundary } from '../components/shared/error-boundary';
   import { AnalyticsProvider } from '../lib/hooks/use-analytics';

   // Police personnalisée
   import { loadCustomFonts } from '../assets/fonts/font-loader';

   // Initialisation du client React Query
   const queryClient = new QueryClient({
     defaultOptions: {
         queries: {
               retry: 2,
                     staleTime: 1000 * 60 * 5, // 5 minutes
                           cacheTime: 1000 * 60 * 30, // 30 minutes
                               },
                                 },
                                 });

                                 export default function RootLayout() {
                                   // Chargement des polices
                                     const [fontsLoaded] = useFonts(loadCustomFonts());

                                       if (!fontsLoaded) {
                                           return null; // On pourrait afficher un splash screen ici
                                             }

                                               return (
                                                   <ErrorBoundary>
                                                         <GestureHandlerRootView style={{ flex: 1 }}>
                                                                 <SafeAreaProvider>
                                                                           <QueryClientProvider client={queryClient}>
                                                                                       <AuthProvider>
                                                                                                     <ThemeProvider>
                                                                                                                     <AnalyticsProvider>
                                                                                                                                       {/* Configuration de la barre de statut */}
                                                                                                                                                         <StatusBar style="auto" />
                                                                                                                                                                           
                                                                                                                                                                                             {/* Navigation Stack principale */}
                                                                                                                                                                                                               <Stack
                                                                                                                                                                                                                                   screenOptions={{
                                                                                                                                                                                                                                                         headerShown: false,
                                                                                                                                                                                                                                                                               animation: 'slide_from_right',
                                                                                                                                                                                                                                                                                                     contentStyle: { backgroundColor: 'transparent' },
                                                                                                                                                                                                                                                                                                                         }}
                                                                                                                                                                                                                                                                                                                                           >
                                                                                                                                                                                                                                                                                                                                                               {/* Écrans d'authentification */}
                                                                                                                                                                                                                                                                                                                                                                                   <Stack.Screen
                                                                                                                                                                                                                                                                                                                                                                                                         name="(auth)"
                                                                                                                                                                                                                                                                                                                                                                                                                               options={{
                                                                                                                                                                                                                                                                                                                                                                                                                                                       animation: 'fade',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         {/* Onglets principaux */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <Stack.Screen
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   name="(tabs)"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         options={{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 animation: 'slide_from_bottom',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   {/* Écran de chat */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       <Stack.Screen
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             name="chat/[id]"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   options={{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           animation: 'slide_from_right',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             {/* Écran de communauté */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <Stack.Screen
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       name="community/[id]"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             options={{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     animation: 'slide_from_right',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       {/* Écran premium */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           <Stack.Screen
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 name="premium/subscribe"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       options={{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               animation: 'slide_from_bottom',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       presentation: 'modal',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         {/* Écran watch party */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <Stack.Screen
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   name="watch-party/[id]"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         options={{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 animation: 'slide_from_right',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </Stack>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </AnalyticsProvider>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </ThemeProvider>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </AuthProvider>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </QueryClientProvider>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </SafeAreaProvider>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </GestureHandlerRootView>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </ErrorBoundary>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     } 